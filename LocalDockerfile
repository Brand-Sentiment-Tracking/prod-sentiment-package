ARG IMAGE_VARIANT=slim-buster
ARG OPENJDK_VERSION=8
ARG PYTHON_VERSION=3.9.8

FROM python:${PYTHON_VERSION}-${IMAGE_VARIANT} AS py3
FROM openjdk:${OPENJDK_VERSION}-${IMAGE_VARIANT}

ADD https://www.apache.org/dyn/closer.lua/spark/spark-3.1.3/spark-3.1.3-bin-hadoop3.2.tgz /spark-3.1.3-bin-hadoop3.2.tgz
RUN tar zxvf spark-3.1.3-bin-hadoop3.2.tgz

ENV SPARK_HOME=/spark-3.1.3-bin-hadoop3.2.tgz
ENV PATH=${SPARK_HOME}/bin:${PATH}

COPY --from=py3 / /

RUN python -m venv app

WORKDIR /app/

COPY brand_sentiment/ brand_sentiment/
COPY articles/ articles/
COPY main.py .

COPY requirements.txt .

RUN . ./bin/activate && \
    pip install --upgrade pip && \
    pip install -r requirements.txt

ENTRYPOINT . ./bin/activate && ./bin/spark-submit main.py